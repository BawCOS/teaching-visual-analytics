# Exploratory Visual Analytics {#Chpt2}

> “It isn’t accidental that when we begin to understand something we say 'I see.' 
> Not 'I hear' or 'I smell'” -- Stephen Few

> "You see alot just by looking"  -- Yogi Berra

> Visualization can surprise but doesn't scale well. Modeling scales well but cannot surprise you. -- Hadley Wickham


This chapter starts with visualization and explores relationships between variables. Ultimately, we will be recreated Hans Rosling's famous animated visualization from his [TED talk](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen?language=en ). We will again using R to generate the display however, if you don't want to use R go the gapminder website, https://www.gapminder.org/, and under the header tools, you will have access to all the data as well as an interactive scatter plot.

## Lesson Preparation

### Objectives:  

After the training, students will:
  
1.    explain the basic principles of visual displays of data
2.    be able to generate an animated visualization 
3.    be able to evaluate and compare visual displays of data 


### Preparation

Prior to class, complete the following 
1. Watch the video from [Hans Rosling](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen#t-1052481) entitled "The best stats you've ever seen" .  

2. Go to the [gapminder website](https://www.gapminder.org/) and under the tab tools, experiment with some data.

## Lesson Introduction {#Intro2}

Suggestions to start the lesson:

1. In the video, Rosling mentions that his students believe that developed countries have long life expectancies and low birth rates while developing countries are the opposite. What are some other distinctions between these categories?  

There are many ways to answer this question and your students may talk about GPD, infant mortality rates, and age of population.

2.  What do you think made Hans Rosling's presentation so effective? What did you like about the visualizations? What are some of the design principles you learned from this video?

We are replicating Figure \@ref(fig:fig0) below to remind you of the process for visual analytics. We are assuming that you have read Chapter \@ref(#Chpt1) even if you did not use the material. In this lesson we will be jumping into the visualization portion of the cycle first in an attempt to find insight. We are looking for a way to determine developed and developing countries and watch their progression over time. Thus we will go to analytical reasoning and interaction after starting with the visualization. We must start with data collection first.  

![](./images/Cycle.png)  

## Data Collection  

The data for this lesson comes from the [Gapminder](https://www.gapminder.org/data/) website. Again, you could just start with the **tools** application on the website instead of using the R code here. This section will be long but remember that data wrangling can take up to 80% of the time in a project.  

First we will load two pacages we need. The data is downloaded in a Excel spreadsheet; we will use the package **readxl** to read it.  In addition, R has a package called **gapminder** which is a subset of the data from the Gapminder website. We will use it to get country names to reduce the size of our data and exclude countries with a large amount of missing data.  

```{r eval=FALSE}
library(readxl)
library(gapminder)
library(dplyr)
library(tidyverse)
```

The data has been downloaded and is in the **data** folder on the GitHub site for this book.

```{r}
gapminder_population_temp <- read_excel("data/indicator gapminder population.xlsx")
gapminder_population_temp
```

From the **gapminder** package, we will get the subset of countries where the data is most complete.

```{r}
countries<-levels(gapminder$country)
```

Finally, we will wrangle the data into the final form needed.

```{r}
gapminder_population<-gapminder_population_temp %>%
  gather(year,pop,-"Total population") %>%
  rename(country="Total population") %>%
  mutate(year=as.integer(year),pop=as.integer(pop)) %>%
  filter(country %in% countries,year>=1950)
gapminder_population
```

Before proceeding. We will check the quality of the data.

```{r}
length(countries)
length(unique(gapminder_population$country))
```

There are 142 countries in the **gapminder** data but only 139 in the data we collected. These names might be different from those from the imported data. We will check that first.

```{r}
countries[!(countries %in% unique(gapminder_population$country))]
```

We are missing the two Koreas and Yemen from our data.

We need the full list of countries, so we have to start over.

```{r}
gapminder_population<-gapminder_population_temp %>%
  gather(year,pop,-"Total population") %>%
  rename(country="Total population") %>%
  mutate(year=as.integer(year),pop=as.integer(pop)) %>%
  filter(year>=1950)
gapminder_population
```

```{r}
unique(gapminder_population$country)[grep("Korea",unique(gapminder_population$country))]
unique(gapminder_population$country)[grep("Yemen",unique(gapminder_population$country))]
```

We now know the problem is that in the **gapminder** package we have the titles
"Korea, Dem. Rep."  
"Korea, Rep."  
"Yemen, Rep."  

while in our data from the gapminder website we have the names
"North Korea"  
"South Korea"
"Yemen"

We will correct the names in the countries vector.

```{r}
which(!(countries %in% unique(gapminder_population$country)))
countries[70]="North Korea"
countries[71]="South Korea"
countries[140]="Yemen"
```

We will check our data again.

```{r}
sum(!(countries %in% unique(gapminder_population$country)))
```

```{r}
gapminder_population<-gapminder_population_temp %>%
  gather(year,pop,-"Total population") %>%
  rename(country="Total population") %>%
  mutate(year=as.integer(year),pop=as.integer(pop)) %>%
  filter(country %in% countries,year>=1950)
gapminder_population
```

As a check, we will look for missing observations.

```{r}
gapminder_population[is.na(gapminder_population$pop),]
```

We are missing the last two years of data for Taiwan. We could drop Taiwan or get another estimate of the population from the web.  Using the website http://www.worldometers.info/world-population/taiwan-population/ we see that for the last four years the population has grown by about 70000 each year. So we will estimate the population for 2014 and 2015 by adding 70000 to the population in 2013 for each year.. 

```{r}
gapminder_population[is.na(gapminder_population$pop),][1,3]=23151000 + 70000
gapminder_population[is.na(gapminder_population$pop),][1,3]=23151000 + 140000
```

Now we need to add the continents to the dataframe.

```{r}
dict<-gapminder %>% group_by(continent) %>% distinct(country) %>%
  mutate(country=as.character(country))
```

We still have the problem with the three countries.  

```{r}
dict$country[is.na(match(dict$country,countries))]
dict$country[is.na(match(dict$country,countries))]=c("North Korea","South Korea","Yemen")
```

Now we will add continent to the data.

```{r}
gapminder_population <- gapminder_population %>% 
  left_join(dict,by="country") %>%
  select(country,continent,year,pop)
gapminder_population
```

Clean up by removing temporary objects.

```{r}
rm(gapminder_population_temp)
```

Next we bring in life expectancy data.

```{r}
gapminder_lifeexp_temp <- read_excel("data/indicator life_expectancy_at_birth.xlsx")
```


```{r}
gapminder_lifeexp<-gapminder_lifeexp_temp %>%
  gather(year,life_exp,-"Life expectancy") %>%
  rename(country="Life expectancy") %>%
  mutate(year=as.integer(year)) %>%
  filter(country %in% countries,year>=1950)
rm(gapminder_lifeexp_temp)
gapminder_lifeexp
```

```{r}
gapminder_lifeexp <- gapminder_lifeexp %>% 
  left_join(dict,by="country") %>%
  select(country,continent,year,life_exp)
gapminder_lifeexp
```

Next is fertility rates.

```{r}
gapminder_fertility_temp <- read_excel("data/indicator undata total_fertility.xlsx")
```


```{r}
gapminder_fertility<-gapminder_fertility_temp %>%
  gather(year,fertility,-"Total fertility rate") %>%
  rename(country="Total fertility rate") %>%
  mutate(year=as.integer(year)) %>%
  filter(country %in% countries,year>=1950)
rm(gapminder_fertility_temp)
gapminder_fertility
```

We need to check for missing values.

```{r}
sum(is.na(gapminder_fertility$fertility))
```

```{r}
gapminder_fertility[is.na(gapminder_fertility$fertility),]
```

It is the country of Taiwan again that has missing values. I will estimate the fertility with average of the previous 5 years.

```{r}
temp<-as.double(gapminder_fertility %>% filter(country=="Taiwan",year<2014 & year>2008) %>% summarise(ave=mean(fertility)))
gapminder_fertility<-gapminder_fertility %>% replace_na(list(fertility=temp))
rm(temp)
```


```{r}
gapminder_fertility <- gapminder_fertility %>% 
  left_join(dict,by="country") %>%
  select(country,continent,year,fertility)
gapminder_fertility
```

Next we will collect data on child mortality. This data is the number of children out of 1000 born in the given year that will die before reaching the age of 5.

```{r}
gapminder_mortality5_temp <- read_excel("data/indicator gapminder under5mortality.xlsx")
```


```{r}
gapminder_mortality5<-gapminder_mortality5_temp %>%
  gather(year,mortality,-"Under five mortality") %>%
  rename(country="Under five mortality") %>%
  mutate(year=as.integer(year)) %>%
  filter(country %in% countries,year>=1950)
rm(gapminder_mortality5_temp)
gapminder_mortality5
```

We need to check for missing values.

```{r}
sum(is.na(gapminder_mortality5$mortality))
```

```{r}
gapminder_mortality5[is.na(gapminder_mortality5$mortality),]
```

Now Hong Kong, Puerto Rico, and Reunion are missing data up through the year 1979 and Taiwan is missing all years. We could drop Taiwan from the data but that is a waste of the data sets. We could imput the values but we need to be careful when we interpret the resulting plots. The other three countries are going to impose problems for the years prior to 1980.  For ease will will drop these countries from the analysis after we get our final data set.

`
```{r}
gapminder_mortality5 <- gapminder_mortality5 %>% 
  left_join(dict,by="country") %>%
  select(country,continent,year,mortality)
gapminder_mortality5
```

Another thought may be that developed countries have an older population by percentage. We will next collect data on the percent of population above 60 years in age.

```{r}
gapminder_above60_temp <- read_excel("data/indicator_total above 60 percen.xlsx")
```


```{r}
gapminder_above60<-gapminder_above60_temp %>%
  gather(year,above60,-"Total above 60 (%)") %>%
  rename(country="Total above 60 (%)") %>%
  mutate(year=as.integer(year)) %>%
  filter(country %in% countries,year>=1950)
rm(gapminder_above60_temp)
gapminder_above60
```

```{r}
sum(is.na(gapminder_above60$above60))
```
No missing values.

But the data is only for every 5 years and has projections.

```{r}
unique(gapminder_above60$year)
```

We will first remove the projections.

```{r}
gapminder_above60 <- gapminder_above60 %>% filter(year <= 2015)
```

Before we interpolate, let's look at two countries to get an idea of the data.

```{r}
p<-gapminder_above60 %>% filter(country=="Albania" | country=="United States") %>%
  ggplot(aes(x=year,y=above60,color=country))+
  geom_point()
p
```

We will use a spline to interpolate the data but we will first plot a linear interpolation to compare the the spline.

```{r}
temp1<-data.frame(with(gapminder_above60 %>% 
        filter(country=="Albania"),approx(year,above60,xout=seq(1950,2015)))) %>% 
  mutate(country="Albania")
temp2<-data.frame(with(gapminder_above60 %>% 
        filter(country=="United States"),approx(year,above60,xout=seq(1950,2015)))) %>% 
  mutate(country="United States")
```


```{r}
p+
  geom_line(data=temp1,mapping=aes(x=x,y=y)) +
  geom_line(data=temp2,mapping=aes(x=x,y=y)) +
  labs(x="Year",y="Percentage of Population above 60 years",title="Estimating Percent of Population Above 60",subtitle="Linear Interpolation")
```

```{r}
temp1<-data.frame(with(gapminder_above60 %>% 
        filter(country=="Albania"),spline(year,above60,xout=seq(1950,2015)))) %>% 
  mutate(country="Albania")
temp2<-data.frame(with(gapminder_above60 %>% 
        filter(country=="United States"),spline(year,above60,xout=seq(1950,2015)))) %>% 
  mutate(country="United States")
```

```{r}
p+
  geom_line(data=temp1,mapping=aes(x=x,y=y)) +
  geom_line(data=temp2,mapping=aes(x=x,y=y)) +
  labs(x="Year",y="Percentage of Population above 60 years",title="Estimating Percent of Population Above 60",subtitle="Linear Interpolation")
```

Now we need to interpolate for every country and create our final data frame. 

Test code

gapminder_above60 %>% filter(country=="Albania" | country=="United States") %>% split(.$country) %>%
map(~spline(.$year,.$above60,xout=seq(1950,2015)))



```{r}
gapminder_above60_temp <- gapminder_above60 %>% 
  left_join(dict,by="country") %>%
  select(country,continent,year,above60)
gapminder_above60_temp
```

Data quality check

```{r}
table(gapminder_population$continent)/66
table(gapminder_lifeexp$continent)/67
table(gapminder_fertility$continent)/66
table(dict$continent)
for (name in (dict %>% filter(continent=="Asia"))$country){
  if (length((gapminder_fertility %>% filter(country==name))$year)==0){print(name)}
  }
```

