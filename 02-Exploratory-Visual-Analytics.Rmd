# Exploratory Visual Analytics {#Chpt2}

> “It isn’t accidental that when we begin to understand something we say 'I see.' 
> Not 'I hear' or 'I smell'” -- Stephen Few

> "You see alot just by looking"  -- Yogi Berra

> Visualization can surprise but doesn't scale well. Modeling scales well but cannot surprise you. -- Hadley Wickham


This chapter starts with visualization and explores relationships between variables. Ultimately, we will be recreating a chart similar to Hans Rosling's famous animated visualization from his [TED talk](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen?language=en ). We will be using R to generate the display however, if you don't want to use R go the gapminder website, https://www.gapminder.org/, and under the header **tools**, you will have access to all the data as well as an interactive scatter plot. Another avenue you could explore is to use data directly from the [World Bank](https://data.worldbank.org/). On their website you can create interactive visual displays, https://data.worldbank.org/.

## Lesson Preparation

### Objectives:  

After the training, students will:
  
1.    explain the basic principles of visual displays of data
2.    be able to generate an animated visualization 
3.    be able to evaluate and compare visual displays of data 


### Preparation

Prior to class, complete the following 
1. Watch the video from [Hans Rosling](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen#t-1052481) entitled "The best stats you've ever seen" .  

2. Go to the [gapminder website](https://www.gapminder.org/) and under the tab **tools**, experiment with the data.

## Lesson Introduction {#Intro2}

Suggestions to start the lesson:

1. In the video, Rosling mentions that his students believe that developed countries have long life expectancies and low birth rates while developing countries are the opposite. What are some other distinctions between these categories?  

There are many ways to answer this question and your students may talk about GPD, infant mortality rates, and age of population.

2.  What do you think made Hans Rosling's presentation so effective? What did you like about the visualizations? What are some of the design principles you learned from this video?

We are replicating Figure \@ref(fig:fig0) below to remind you of the process for visual analytics. We are assuming that you have read Chapter \@ref(#Chpt1) even if you did not use the material. In this lesson we will be jumping into the visualization portion of the cycle first in an attempt to find insight. We are looking for a way to determine developed and developing countries and watch their progression over time. Thus we will go to analytical reasoning and interaction after starting with the visualization. We must start with data collection first.  

![](./images/Cycle.png)  

## Data Collection  

The data for this lesson comes from the [Gapminder](https://www.gapminder.org/data/) website. Again, you could just start with the **tools** application on the website instead of using the R code here. This section will be long but remember that data wrangling can take up to 80% of the time in a project. We also provide the final data in a csv file on the github site for this book. The file name is Gapminder_final.csv.  

### Load Packages  

First we will load two packages we need. The data is downloaded in a Excel spreadsheet; we will use the package **readxl** to read it.  In addition, R has a package called **gapminder** which is a subset of the data from the Gapminder website. We will use it to get country names to reduce the size of our data and exclude countries with a large amount of missing data.  

```{r eval=FALSE}
library(readxl)
library(gapminder)
library(tidyverse)
```

The data has been downloaded and is in the **data** folder on the GitHub site for this book.

### Population  

```{r}
gapminder_population_temp <- read_excel("data/indicator gapminder population.xlsx")
gapminder_population_temp %>% head() %>% knitr::kable()
```

From the **gapminder** package, we will get the subset of countries where the data is most complete.

```{r}
countries<-levels(gapminder$country)
```

Finally, we will wrangle the data into the final form needed.

```{r}
gapminder_population<-gapminder_population_temp %>%
  gather(year,pop,-"Total population") %>%
  rename(country="Total population") %>%
  mutate(year=as.integer(year),pop=as.integer(pop)) %>%
  filter(country %in% countries,year>=1950)
gapminder_population %>% head() %>% knitr::kable()
```

Before proceeding. We will check the quality of the data.

```{r}
length(countries)
length(unique(gapminder_population$country))
```

There are 142 countries in the **gapminder** data but only 139 in the data we collected that match those 142 countries. There might some names in **gapminder** that are different from those from the imported data. We will check this idea first.

```{r}
countries[!(countries %in% unique(gapminder_population$country))]
```

We are missing the two Koreas and Yemen from our data.

```{r}
unique(gapminder_population$country)[grep("Korea",unique(gapminder_population$country))]
unique(gapminder_population$country)[grep("Yemen",unique(gapminder_population$country))]
```

We now know the problem is that in the **gapminder** package we have the titles
"Korea, Dem. Rep."  
"Korea, Rep."  
"Yemen, Rep."  

while in our data from the gapminder website we have the names
"North Korea"  
"South Korea"
"Yemen"


We need the full list of countries in the original data to change the names.

```{r}
gapminder_population<-gapminder_population_temp %>%
  gather(year,pop,-"Total population") %>%
  rename(country="Total population") %>%
  mutate(year=as.integer(year),pop=as.integer(pop)) %>%
  filter(year>=1950)
```


We will correct the names in the our data.

```{r}
gapminder_population$country<-gsub("North Korea","Korea, Dem. Rep.",gapminder_population$country)
gapminder_population$country<-gsub("South Korea","Korea, Rep.",gapminder_population$country)
gapminder_population$country<-gsub("Yemen","Yemen, Rep.",gapminder_population$country)
```

We will check our data again.

```{r}
sum(!(countries %in% unique(gapminder_population$country)))
```

Finally we will get rid of the countries not in the **gapminder** package.

```{r}
gapminder_population<-gapminder_population %>%
  filter(country %in% countries)
gapminder_population
```

Next we will look for missing observations.

```{r}
gapminder_population[is.na(gapminder_population$pop),]
```

We are missing the last two years of data for Taiwan. We could drop Taiwan or get another estimate of the population from the web.  Using the website http://www.worldometers.info/world-population/taiwan-population/ we see that for the last four years the population has grown by about 70000 each year. So we will estimate the population for 2014 and 2015 by adding 70000 to the population in 2013 for each year.. 

```{r}
gapminder_population[is.na(gapminder_population$pop),][1,3]=23151000 + 70000
gapminder_population[is.na(gapminder_population$pop),][1,3]=23151000 + 140000
```

Now we need to add the continents to the data frame.

```{r}
dict<-gapminder %>% group_by(continent) %>% distinct(country) %>%
  mutate(country=as.character(country))
```


```{r}
gapminder_population <- gapminder_population %>% 
  left_join(dict,by="country") %>%
  select(country,continent,year,pop)
gapminder_population
```

Clean up by removing temporary objects.

```{r}
rm(gapminder_population_temp)
```

### Life Expectancy  

Next we bring in life expectancy data and since the source is the same we will have the same issue with the names of the Koreas and Yemen.

```{r}
gapminder_lifeexp_temp <- read_excel("data/indicator life_expectancy_at_birth.xlsx")
```


```{r}
gapminder_lifeexp<-gapminder_lifeexp_temp %>%
  gather(year,life_exp,-"Life expectancy") %>%
  rename(country="Life expectancy") %>%
  mutate(year=as.integer(year)) %>%
  filter(year>=1950)
rm(gapminder_lifeexp_temp)
gapminder_lifeexp
```

```{r}
gapminder_lifeexp$country<-gsub("North Korea","Korea, Dem. Rep.",gapminder_lifeexp$country)
gapminder_lifeexp$country<-gsub("South Korea","Korea, Rep.",gapminder_lifeexp$country)
gapminder_lifeexp$country<-gsub("Yemen","Yemen, Rep.",gapminder_lifeexp$country)
```

```{r}
gapminder_lifeexp<-gapminder_lifeexp %>%
  filter(country %in% countries)
gapminder_lifeexp
```

```{r}
sum(is.na(gapminder_lifeexp))
```


```{r}
gapminder_lifeexp <- gapminder_lifeexp %>% 
  left_join(dict,by="country") %>%
  select(country,continent,year,life_exp)
gapminder_lifeexp
```

### Fertility Rates  

Next is fertility rates.

```{r}
gapminder_fertility_temp <- read_excel("data/indicator undata total_fertility.xlsx")
```


```{r}
gapminder_fertility<-gapminder_fertility_temp %>%
  gather(year,fertility,-"Total fertility rate") %>%
  rename(country="Total fertility rate") %>%
  mutate(year=as.integer(year)) %>%
  filter(year>=1950)
rm(gapminder_fertility_temp)
gapminder_fertility
```


```{r}
gapminder_fertility$country<-gsub("North Korea","Korea, Dem. Rep.",gapminder_fertility$country)
gapminder_fertility$country<-gsub("South Korea","Korea, Rep.",gapminder_fertility$country)
gapminder_fertility$country<-gsub("Yemen","Yemen, Rep.",gapminder_fertility$country)
```

```{r}
gapminder_fertility<-gapminder_fertility %>%
  filter(country %in% countries)
gapminder_fertility
```

```{r}
length(unique(gapminder_fertility$country))
```

We need to check for missing values.

```{r}
sum(is.na(gapminder_fertility$fertility))
```

```{r}
gapminder_fertility[is.na(gapminder_fertility$fertility),]
```

It is the country of Taiwan again that has missing values. I will estimate the fertility with average of the previous 5 years.

```{r}
temp<-as.double(gapminder_fertility %>% filter(country=="Taiwan",year<2014 & year>2008) %>% summarise(ave=mean(fertility)))
gapminder_fertility<-gapminder_fertility %>% replace_na(list(fertility=temp))
rm(temp)
```


```{r}
gapminder_fertility <- gapminder_fertility %>% 
  left_join(dict,by="country") %>%
  select(country,continent,year,fertility)
gapminder_fertility
```

### Child Mortality  

Next we will collect data on child mortality. This data is the number of children out of 1000 born in the given year that will die before reaching the age of 5.

```{r}
gapminder_mortality5_temp <- read_excel("data/indicator gapminder under5mortality.xlsx")
```


```{r}
gapminder_mortality5<-gapminder_mortality5_temp %>%
  gather(year,mortality,-"Under five mortality") %>%
  rename(country="Under five mortality") %>%
  mutate(year=as.integer(year)) %>%
  filter(year>=1950)
rm(gapminder_mortality5_temp)
gapminder_mortality5
```

```{r}
gapminder_mortality5$country<-gsub("North Korea","Korea, Dem. Rep.",gapminder_mortality5$country)
gapminder_mortality5$country<-gsub("South Korea","Korea, Rep.",gapminder_mortality5$country)
gapminder_mortality5$country<-gsub("Yemen","Yemen, Rep.",gapminder_mortality5$country)
```

```{r}
gapminder_mortality5<-gapminder_mortality5 %>%
  filter(country %in% countries)
gapminder_mortality5
```

We need to check for missing values.

```{r}
sum(is.na(gapminder_mortality5$mortality))
```

```{r}
gapminder_mortality5[is.na(gapminder_mortality5$mortality),]
```

Now Hong Kong, Puerto Rico, and Reunion are missing data up through the year 1979 and Taiwan is missing all years. We could drop Taiwan from the data but that is a waste of the data sets. We could impute the values but we need to be careful when we interpret the resulting plots. The other three countries are going to impose problems for the years prior to 1980.  For ease will will drop these countries from the analysis after we get our final data set.

`
```{r}
gapminder_mortality5 <- gapminder_mortality5 %>% 
  left_join(dict,by="country") %>%
  select(country,continent,year,mortality)
gapminder_mortality5
```

### Aging Population  

Another thought is developed countries have an older population by percentage. We will next collect data on the percent of population above 60 years in age.

```{r}
gapminder_above60_temp <- read_excel("data/indicator_total above 60 percen.xlsx")
```


```{r}
gapminder_above60<-gapminder_above60_temp %>%
  gather(year,above_60,-"Total above 60 (%)") %>%
  rename(country="Total above 60 (%)") %>%
  mutate(year=as.integer(year)) %>%
  filter(year>=1950)
rm(gapminder_above60_temp)
gapminder_above60
```

This data came from a different source, so we need to be careful about the country names and which ones are contained in the data set.

```{r}
countries[!countries %in% unique(gapminder_above60$country)]
```

Taiwan is still a problem but now we have three other countries that are in the **gapminder** package and not in the new data set.

Let's remove all the countries that are causing us problems.

```{r}
countries<- countries[!countries %in% 
unique(c(unique(gapminder_mortality5[is.na(gapminder_mortality5$mortality),]$country),
countries[!countries %in% unique(gapminder_above60$country)]))]
```


```{r}
gapminder_above60<-gapminder_above60 %>%
  filter(country %in% countries)
gapminder_above60
```

```{r}
sum(is.na(gapminder_above60$above_60))
```  

There are no missing values.

But the data is only for every 5 years and has projections past 2015.

```{r}
unique(gapminder_above60$year)
```

We will first remove the projections.

```{r}
gapminder_above60 <- gapminder_above60 %>% filter(year <= 2015)
```

Before we interpolate, let's look at two countries to get an idea of the data.

```{r}
p<-gapminder_above60 %>% filter(country=="Albania" | country=="United States") %>%
  ggplot(aes(x=year,y=above_60,color=country))+
  geom_point()
p
```

We will use a spline to interpolate the data but we will first plot a linear interpolation to compare the the spline.

```{r}
temp1<-data.frame(with(gapminder_above60 %>% 
        filter(country=="Albania"),approx(year,above_60,xout=seq(1950,2015)))) %>% 
  mutate(country="Albania")
temp2<-data.frame(with(gapminder_above60 %>% 
        filter(country=="United States"),approx(year,above_60,xout=seq(1950,2015)))) %>% 
  mutate(country="United States")
```


```{r}
p+
  geom_line(data=temp1,mapping=aes(x=x,y=y)) +
  geom_line(data=temp2,mapping=aes(x=x,y=y)) +
  labs(x="Year",y="Percentage of Population above 60 years",title="Estimating Percent of Population Above 60",subtitle="Linear Interpolation")
```

```{r}
temp1<-data.frame(with(gapminder_above60 %>% 
        filter(country=="Albania"),spline(year,above_60,xout=seq(1950,2015)))) %>% 
  mutate(country="Albania")
temp2<-data.frame(with(gapminder_above60 %>% 
        filter(country=="United States"),spline(year,above_60,xout=seq(1950,2015)))) %>% 
  mutate(country="United States")
```

```{r}
p+
  geom_line(data=temp1,mapping=aes(x=x,y=y)) +
  geom_line(data=temp2,mapping=aes(x=x,y=y)) +
  labs(x="Year",y="Percentage of Population above 60 years",title="Estimating Percent of Population Above 60",subtitle="Spline Interpolation")
```

Clean the work space.

```{r}
rm(temp1)
rm(temp2)
```

If you did not want the temporary variables we could have used the code in one step.

```{r}
p+ data.frame(with(gapminder_above60 %>% 
  filter(country=="Albania"),spline(year,above_60,xout=seq(1950,2015)))) %>% 
  mutate(country="Albania") %>%
  geom_line(mapping=aes(x=x,y=y)) +
  data.frame(with(gapminder_above60 %>% 
  filter(country=="United States"),spline(year,above_60,xout=seq(1950,2015)))) %>% 
  mutate(country="United States") %>%
  geom_line(mapping=aes(x=x,y=y)) +
  labs(x="Year",y="Percentage of Population above 60 years",
       title="Estimating Percent of Population Above 60",subtitle="Spline Interpolation")
```


Now we need to interpolate for every country and create our final data frame. We will use the map function from the **purrr** package.  

```{r}
gapminder_above60<-gapminder_above60 %>%
  split(.$country) %>%
  map(~data.frame(spline(.$year,.$above_60,xout=seq(1950,2015)))) %>%
  map2_df(countries,~update_list(.x,country=.y)) %>%
  mutate(year=as.integer(x),above_60=y) %>%
  select(country,year,above_60) %>% as.tibble()
```

We finish by adding continent.

```{r}
gapminder_above60 <- gapminder_above60 %>% 
  left_join(dict,by="country") %>%
  select(country,continent,year,above_60) %>%
  arrange(year,country)
gapminder_above60
```

```{r}
p+
  geom_line(data=gapminder_above60%>%filter(country=="Albania"),mapping=aes(x=year,y=above_60)) +
  geom_line(data=gapminder_above60%>%filter(country=="United States"),mapping=aes(x=year,y=above_60)) +
  labs(x="Year",y="Percentage of Population above 60 years",title="Estimating Percent of Population Above 60",subtitle="Spline Interpolation") +theme_classic()
```

### Final Data  

First we will do a quick quality check.

```{r}
table(gapminder_population$continent)/66
table(gapminder_lifeexp$continent)/67
table(gapminder_fertility$continent)/66
table(gapminder_mortality5$continent)/66
table(gapminder_above60$continent)/66
table(dict$continent)
```

We have two problems left, the percentage of the population above 60 has less countries than the other data sets and life expectancy has one more year, 2016, than the other data sets. We will resolve this problem by dropping the 7 countries and the year 2016.

```{r}
gapminder_population %>% summarise(Total=n_distinct(country))
gapminder_above60 %>% summarise(Total=n_distinct(country))
unique(gapminder_population$country)[!unique(gapminder_population$country) %in% countries]
```

We drop by using the join function.

```{r}
gapminder_va<-gapminder_above60 %>%
  left_join(gapminder_lifeexp,by=c("country","year","continent")) %>%
  left_join(gapminder_fertility,by=c("country","year","continent")) %>%
  left_join(gapminder_population,by=c("country","year","continent")) %>%
  left_join(gapminder_mortality5,by=c("country","year","continent")) %>%
  arrange(country,year)
```  

Let's look at the data.

```{r}
gapminder_va %>% head() %>% knitr::kable()
```

One last note is that we have not included an economic metric such as gross domestic product, GDP, per capita. The reason is that the data is sparse. On the gapminder website the data starts in 1960 and ends in 2011; in addition many countries are missing data. On the World Bank site, the data is more complete but still has many missing values and goes from 1960 to 2016. The data in the **gapminder** package in R has data for each country but only in five year increments and ends in 2007. if you want to include GDP data you would have to make the choice of limiting the number of years, interpolating, and/or removing more countries. It would be too much to extrapolate from 2007 to 2015, so a possible solution is to merge the World Bank data with the data from the **gapminder** package. However, they are inflation adjusted on different times so a correction would have to be made. The World Bank data was in current US dollars while the **gapminder** package used something earlier, maybe 2000.

Here is some code to investigate how to incorporate GDP, but we will not do it for our work.

```{r}
gapminder_gdp_temp <- read_excel("data/World Bank GDP.xlsx",skip=4)
```

```{r}
gapminder_gdp<-gapminder_gdp_temp %>%
  gather(year,gdpPercap,-("Country Name":"Indicator Code")) %>%
  select(-(`Country Code`:`Indicator Code`)) %>%
  rename(country="Country Name") %>%
  mutate(year=as.integer(year)) 
```

We have a problem with the names of the countries again. 

```{r}
gdp_countries<-unique(gapminder_gdp$country)
countries[!countries %in% gdp_countries]
```

There is a problem, we will determine if these countries are in the new data set and then correct the names.

```{r}
ind<-vector()
for (country in countries[!countries %in% gdp_countries]){
  ind<-c(ind,grep(substr(country,1,6),gdp_countries))
}
gdp_countries[ind]
```

Let's fix the names. We know *Korea, Rep.* is correct, let's remove it.

```{r}
ind<-ind[-4]
```


```{r}
#Two vectors of names to run a loop over
old_names<-gdp_countries[ind]
new_names<-countries[!countries %in% gdp_countries]
for (i in seq_along(new_names)){
gapminder_gdp$country<-gsub(old_names[i],new_names[i],gapminder_gdp$country)
}
```


```{r}
gapminder_gdp<-gapminder_gdp %>%
  filter(country %in% countries,year>=1992,year<2017) %>%
  arrange(country,year)
```

Add continents to the data set.

```{r}
gapminder_gdp <- gapminder_gdp %>% 
  left_join(dict,by="country") %>%
  select(country,continent,year,gdpPercap) %>%
  arrange(year,country)
gapminder_gdp
```

Now let's get the data from the **gapminder** package and compare the years to determine how to adjust.

```{r}
head(gapminder_gdp %>% filter(year == 2007) %>% select(gdpPercap)/
gapminder %>% filter(year == 2007,country %in% countries) %>% select(gdpPercap) -
(gapminder_gdp %>% filter(year == 2002) %>% select(gdpPercap)/
gapminder %>% filter(year == 2002,country %in% countries) %>% select(gdpPercap)))
```

The adjustment is not consistent so we are missing some thing in this data. We will stop here but if you wanted to continue, you would adjust the data from the World Bank to be consistent with the **gapminder** data and then use interpolation similar to what was done with percentage of population above 60.

We want to clean our work space.

```{r}
rm(gapminder_gdp_temp)
rm(new_names)
rm(old_names)
```

Finally, we will write the data to a csv for use as needed for instruction.

```{r eval=FALSE}
write.csv(gapminder_va,file="data/Gapminder_final.csv")
```

### Summary of Data Collection  

Explain what each variable is

## Visualization of Data 


